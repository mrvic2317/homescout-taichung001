# CSV 房價查詢測試說明

## 快速測試

### 1. 確認 CSV 檔案存在

```bash
ls -lh data/taichung_prices.csv
```

**預期輸出：**
```
-rw-r--r-- 1 user user 4.5K Nov 2 18:30 data/taichung_prices.csv
```

### 2. 啟動 Bot

```bash
python3 bot.py
```

**預期輸出：**
```
INFO:__main__:房價查詢功能已啟用 | cache_ttl=24小時
INFO:__main__:快取有效期限已設定為 24 小時
INFO:__main__:VicBot 已上線，登入為 ...
```

### 3. Discord 測試指令

#### 測試 1：查詢北屯區

```
!房價查詢 北屯區
```

**預期結果：**
- 顯示「🔍 正在查詢...」
- 讀取 CSV 檔案
- 顯示北屯區房價統計 Embed
- 包含約 15-20 筆交易記錄

**日誌範例：**
```
INFO:__main__:房價查詢請求 | user=TestUser | area=北屯區 | guild=...
INFO:__main__:正在查詢房價數據 | district=北屯區 | road=None
INFO:__main__:正在讀取 CSV 檔案 | path=data/taichung_prices.csv
INFO:__main__:CSV 讀取完成 | 總筆數=30
INFO:__main__:CSV 快取已更新 | 筆數=30
INFO:__main__:查詢完成 | district=北屯區 | road=None | 筆數=15
INFO:__main__:✅ 房價查詢成功 | user=TestUser | area=北屯區 | transactions=15
```

#### 測試 2：查詢西屯區

```
!房價查詢 西屯區
```

**預期結果：**
- 快取命中（不重新讀取 CSV）
- 顯示西屯區房價統計
- 包含約 10 筆交易記錄

**日誌範例：**
```
INFO:__main__:CSV 快取命中
INFO:__main__:查詢完成 | district=西屯區 | road=None | 筆數=10
```

#### 測試 3：查詢特定路名

```
!房價查詢 北屯區文心路
```

**預期結果：**
- 過濾出文心路的交易記錄
- 顯示約 3-5 筆交易

#### 測試 4：模糊查詢

```
!房價查詢 北屯
```

**預期結果：**
- 自動識別為「北屯區」
- 顯示北屯區房價統計

#### 測試 5：不存在的地區

```
!房價查詢 台北市
```

**預期結果：**
- 顯示紅色 Embed
- 錯誤訊息：「無法識別地區『台北市』...」

#### 測試 6：查無數據的地區

```
!房價查詢 大安區
```

**預期結果：**
- 顯示紅色 Embed
- 錯誤訊息：「查無『大安區』的交易記錄...」

## 檢查點清單

### CSV 讀取

- [ ] CSV 檔案成功讀取
- [ ] 欄位驗證通過
- [ ] 數據快取生效
- [ ] 快取命中時不重新讀檔

### 地區過濾

- [ ] 完整地區名稱過濾正確（例如：北屯區）
- [ ] 模糊查詢正確（例如：北屯 → 北屯區）
- [ ] 路名過濾正確（例如：文心路）
- [ ] 組合查詢正確（例如：北屯區文心路）

### 時間過濾

- [ ] 只包含過去 5 年數據
- [ ] 民國年日期正確轉換
- [ ] 日期解析錯誤被正確處理

### 數據轉換

- [ ] 價格單位轉換正確（元 → 萬元）
- [ ] 面積單位轉換正確（平方公尺 → 坪）
- [ ] 單價計算正確（萬/坪）

### 統計計算

- [ ] 平均價格計算正確
- [ ] 最高/最低價格識別正確
- [ ] 屋齡中位數計算正確
- [ ] 價格趨勢顯示正確

### 錯誤處理

- [ ] CSV 檔案不存在 → 友善錯誤訊息
- [ ] CSV 格式錯誤 → 捕獲異常
- [ ] 地區不存在 → 建議相似地名
- [ ] 查無數據 → 友善提示

### 日誌記錄

- [ ] 成功查詢記錄到 #系統日誌
- [ ] 錯誤記錄到 #異常警告
- [ ] 終端機顯示詳細日誌
- [ ] 日誌包含完整上下文

### 效能

- [ ] 首次查詢 < 3 秒
- [ ] 快取命中查詢 < 1 秒
- [ ] 大型 CSV (>100MB) 可正常處理

## 常見問題

### Q1: 顯示「找不到房價數據檔案」

**原因：** CSV 檔案不存在

**解決：**
```bash
ls data/taichung_prices.csv  # 確認檔案存在
```

### Q2: 顯示「CSV 檔案缺少必要欄位」

**原因：** CSV 欄位名稱不符

**解決：**
1. 打開 CSV 檔案
2. 檢查第一行（標題列）
3. 確認包含：鄉鎮市區、交易年月日、總價元、建物移轉總面積平方公尺、單價元平方公尺

### Q3: 顯示「CSV 檔案編碼錯誤」

**原因：** 檔案不是 UTF-8 編碼

**解決：**
```bash
iconv -f BIG5 -t UTF-8 data/taichung_prices.csv -o data/taichung_prices_utf8.csv
mv data/taichung_prices_utf8.csv data/taichung_prices.csv
```

### Q4: 查詢結果筆數為 0

**原因：** 時間過濾或地區過濾過於嚴格

**解決：**
1. 確認 CSV 包含該地區數據
2. 確認數據日期在過去 5 年內
3. 檢查日期格式是否正確

### Q5: 快取未生效

**原因：** 快取已過期或被清空

**解決：**
- 快取有效期：24 小時
- Bot 重啟會清空快取
- 可在 `.env` 調整 `PRICE_CACHE_TTL_HOURS`

## 效能基準

### 範例 CSV（30 筆）

| 操作 | 時間 |
|-----|------|
| 首次讀取 CSV | ~0.1 秒 |
| 快取命中查詢 | ~0.01 秒 |
| 地區過濾 | ~0.01 秒 |
| 數據轉換 | ~0.02 秒 |
| 統計計算 | ~0.01 秒 |
| **總計（首次）** | **~0.5 秒** |
| **總計（快取）** | **~0.05 秒** |

### 真實 CSV（100,000 筆）

| 操作 | 時間 |
|-----|------|
| 首次讀取 CSV | ~2-3 秒 |
| 快取命中查詢 | ~0.1 秒 |
| **總計（首次）** | **~3 秒** |
| **總計（快取）** | **~0.5 秒** |

## 除錯技巧

### 1. 啟用詳細日誌

在 `bot.py` 修改：
```python
logging.basicConfig(level=logging.DEBUG)  # 原本是 INFO
```

### 2. 檢查快取狀態

在 Python 互動式環境：
```python
from src.services import price_query

# 檢查快取是否有效
is_valid = price_query._csv_cache.is_valid()
print(f"快取有效: {is_valid}")

# 清空快取
price_query._csv_cache.clear()
```

### 3. 手動測試 CSV 讀取

```python
import asyncio
from src.services import price_query

async def test():
    data = await price_query.load_csv_data()
    print(f"讀取 {len(data)} 筆資料")

asyncio.run(test())
```

### 4. 測試地區過濾

```python
from src.services import price_query

# 載入測試數據
import csv
with open("data/taichung_prices.csv", "r", encoding="utf-8") as f:
    reader = csv.DictReader(f)
    data = list(reader)

# 測試過濾
filtered = price_query.filter_by_district_and_road(data, "北屯區", None)
print(f"北屯區: {len(filtered)} 筆")

filtered = price_query.filter_by_district_and_road(data, "北屯區", "文心路")
print(f"北屯區文心路: {len(filtered)} 筆")
```

## 下一步

完成測試後：

1. **替換真實數據**
   - 從政府平台下載完整 CSV
   - 替換 `data/taichung_prices.csv`

2. **調整快取設定**
   - 根據數據大小調整 TTL
   - 考慮使用 Redis 快取

3. **效能優化**
   - 大型 CSV 考慮使用 pandas
   - 建立索引加速查詢

4. **監控與警告**
   - 設定 CSV 檔案大小警告
   - 監控查詢效能
