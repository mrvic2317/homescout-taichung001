### 官方資料自動下載系統說明

## 功能概述

本系統自動從內政部實價登錄網站下載最新的不動產交易資料，並過濾出台中市的交易記錄。

### 核心特性

- ✅ **自動爬取**：從官網爬取最新版本資訊
- ✅ **智能下載**：只在有新版本時下載
- ✅ **資料過濾**：自動過濾台中市交易記錄
- ✅ **版本管理**：記錄版本資訊和快取狀態
- ✅ **備份機制**：自動備份舊資料（保留最近 10 個）
- ✅ **錯誤降級**：網路失敗時使用舊快取
- ✅ **合法授權**：依OGDL授權條款使用

## 資料來源與授權

**資料來源：** 內政部不動產交易實價查詢服務網
**網址：** https://plvr.land.moi.gov.tw/

**授權條款：** 政府資料開放授權條款 (Open Government Data License, OGDL) 第1版
**授權網址：** https://data.gov.tw/license

**授權摘要：**
- ✅ 可自由利用（包括複製、發行、改作等）
- ✅ 可用於商業目的
- ✅ 需標示資料來源
- ✅ 需提供授權條款連結

## 系統架構

```
官方網站 → 爬蟲 → 下載全國資料 → 過濾台中市 → 保存本地
   ↓            ↓              ↓                ↓            ↓
MOI網站    版本檢查    CSV下載(重試3次)   資料過濾    備份舊檔
                       編碼檢測(UTF-8/Big5)
```

## 快速開始

### 1. 測試下載功能

```bash
python3 test_official_downloader.py
```

### 2. 手動觸發下載

```bash
python3 -c "import asyncio; from src.services import official_data_downloader; asyncio.run(official_data_downloader.force_update())"
```

### 3. 檢查版本資訊

```bash
cat data/.version_info.json
```

## 檔案結構

```
data/
├── taichung_prices.csv      # 台中市資料（主檔案）
├── .version_info.json        # 版本資訊（快取狀態）
├── backup/                   # 備份目錄
│   ├── taichung_prices_20251102_140530.csv
│   └── ... (保留最近 10 個)
└── temp_download.csv         # 臨時下載檔案（自動刪除）
```

## 版本資訊格式

`.version_info.json` 範例：

```json
{
  "last_download": "2025-11-02T14:53:00",
  "version": "114年9月11日至9月20日",
  "source_url": "https://plvr.land.moi.gov.tw/...",
  "file_size": 12345678,
  "row_count": 15000,
  "fields": ["鄉鎮市區", "交易年月日", "總價元", ...]
}
```

## 下載邏輯

### 1. 快取檢查
- 檢查本地檔案是否存在
- 檢查快取是否有效（< 7 天）

### 2. 版本比對與獲取

**方法 1（主要）：內政部批次下載連結**
- 使用固定的季度下載連結
- URL 格式：`https://plvr.land.moi.gov.tw/DownloadSeason?season=114S3&type=zip&fileName=lvr_landcsv.zip`
- 優點：穩定、快速、不需要 JavaScript 渲染
- 缺點：需要手動更新季度參數（114S3 → 114S4）

**方法 2（備用）：爬取官網**
- 爬取 https://plvr.land.moi.gov.tw/DownloadOpenData
- 解析 HTML 尋找下載連結
- 注意：官網使用 JavaScript 動態載入，可能需要 Selenium
- 目前作為備用方案

### 3. 下載流程
1. 優先使用內政部批次下載連結
2. 下載 ZIP 檔案（支援重試 3 次）
3. 解壓縮 ZIP，尋找 CSV 檔案
4. 檢測檔案編碼（UTF-8/Big5/GBK）
5. 過濾台中市資料
6. 備份舊檔案
7. 保存新資料
8. 更新版本資訊
9. 清理臨時檔案

### 4. 錯誤降級
- 網路連線失敗 → 使用舊快取（警告日誌）
- 下載失敗 → 重試 3 次，失敗後使用舊快取
- ZIP 解壓失敗 → 記錄錯誤，使用舊快取
- 編碼解析失敗 → 嘗試不同編碼（UTF-8/Big5/GBK）
- 過濾失敗 → 記錄錯誤，使用舊快取

## 自動更新策略

### Bot 啟動時
```python
# bot.py 中的 on_ready()
if self.config.price_query_enabled:
    await self._ensure_price_data()
```

- 檢查快取是否有效
- 有效（< 7 天）→ 使用快取
- 無效或不存在 → 自動下載

### 定期檢查
- 每次啟動檢查一次
- 快取有效期：7 天
- 不會頻繁下載（避免對官網造成負擔）

## 日誌範例

### 成功下載
```
INFO:official_data_downloader:正在爬取最新版本資訊
INFO:official_data_downloader:找到最新版本 | version=114年9月11日至9月20日
INFO:official_data_downloader:發現新版本 | old=114年8月 | new=114年9月11日至9月20日
INFO:official_data_downloader:開始下載 | attempt=1/3
INFO:official_data_downloader:下載進度：50.0% (25.0MB / 50.0MB)
INFO:official_data_downloader:下載進度：100.0% (50.0MB / 50.0MB)
INFO:official_data_downloader:下載成功 | size=50.0MB
INFO:official_data_downloader:開始過濾台中市資料
INFO:official_data_downloader:過濾完成 | 台中市筆數=12500
INFO:official_data_downloader:✅ 資料更新成功 | version=114年9月11日至9月20日 | rows=12500
```

### 使用快取
```
INFO:official_data_downloader:快取有效 | age=2天
INFO:official_data_downloader:已是最新版本 | version=114年9月11日至9月20日
```

### 下載失敗
```
ERROR:official_data_downloader:下載失敗 | attempt=1 | error=Connection timeout
INFO:official_data_downloader:等待 5 秒後重試...
WARNING:official_data_downloader:⚠️ 下載失敗，使用舊快取 | age=5天
```

## Discord 顯示

查詢結果中會顯示：

```
【📄 資料來源與授權】
數據來源：內政部不動產成交案件實價登錄 (114年9月11日至9月20日)
依政府資料開放授權條款 (OGDL) 第1版公眾釋出
授權連結：https://data.gov.tw/license

查詢者：用戶名稱 | 資料筆數：12,500
```

## 常見問題

### Q1: 第一次執行會下載資料嗎？

**是的。** 首次執行時會自動下載最新資料。

### Q2: 多久更新一次？

**7 天。** 快取有效期為 7 天，超過後會自動檢查新版本。

### Q3: 下載失敗怎麼辦？

系統會自動重試 3 次（間隔 5 秒）。全部失敗後會使用舊快取（如果存在）。

### Q4: 資料來自哪裡？

內政部實價登錄網站。原始資料為全國，系統自動過濾台中市。

### Q5: 如何手動更新？

```bash
python3 -c "import asyncio; from src.services import official_data_downloader; asyncio.run(official_data_downloader.force_update())"
```

### Q8: 如何更新季度參數？

**當政府發布新季度資料時（例如：114年第4季），需要更新下載連結。**

**步驟：**
1. 打開 `src/services/official_data_downloader.py`
2. 找到 `_fetch_from_data_gov_tw()` 方法
3. 更新季度參數：

```python
# 舊：114S3（第3季）
api_url = "https://plvr.land.moi.gov.tw/DownloadSeason?season=114S3&type=zip&fileName=lvr_landcsv.zip"

# 新：114S4（第4季）
api_url = "https://plvr.land.moi.gov.tw/DownloadSeason?season=114S4&type=zip&fileName=lvr_landcsv.zip"
```

**季度對應：**
- S1 = 第1季（1-3月）
- S2 = 第2季（4-6月）
- S3 = 第3季（7-9月）
- S4 = 第4季（10-12月）

**年份：**
- 114 = 民國 114 年 = 2025 年
- 115 = 民國 115 年 = 2026 年

### Q6: 舊資料會丟失嗎？

不會。系統會自動備份舊資料到 `data/backup/`，保留最近 10 個版本。

### Q7: 如何查看版本資訊？

```bash
cat data/.version_info.json
```

或在 Python 中：

```python
from src.services import official_data_downloader
info = official_data_downloader.get_version_info()
print(info)
```

## 進階設定

### 調整快取有效期

在 `official_data_downloader.py` 中修改：

```python
# 預設 7 天
CACHE_VALIDITY_DAYS = 7

# 改為 14 天
CACHE_VALIDITY_DAYS = 14
```

### 調整重試次數

```python
# 預設 3 次
MAX_RETRIES = 3

# 改為 5 次
MAX_RETRIES = 5
```

### 調整重試間隔

```python
# 預設 5 秒
RETRY_DELAY = 5

# 改為 10 秒
RETRY_DELAY = 10
```

## 故障排查

### 問題：爬取失敗

**可能原因：**
- 網路連線問題
- 官網結構變更
- 官網維護中

**解決方法：**
1. 檢查網路連線
2. 訪問 https://plvr.land.moi.gov.tw/ 確認官網狀態
3. 查看日誌了解具體錯誤
4. 如果是官網結構變更，需更新爬蟲邏輯

### 問題：編碼錯誤

**可能原因：**
- CSV 檔案編碼不是 UTF-8

**解決方法：**
系統會自動嘗試多種編碼（UTF-8, Big5, GBK）。如果仍失敗，請查看日誌。

### 問題：過濾結果為空

**可能原因：**
- CSV 欄位名稱變更
- 縣市欄位找不到

**解決方法：**
檢查 CSV 欄位，更新 `filter_taichung_data()` 中的欄位名稱匹配邏輯。

## 效能考量

### 下載時間
- 全國資料：約 50-100 MB
- 下載時間：30 秒 - 2 分鐘（視網速）
- 過濾處理：5-10 秒

### 儲存空間
- 台中市資料：約 2-5 MB
- 備份檔案（10個）：約 20-50 MB
- 總計：< 100 MB

### 記憶體使用
- CSV 讀取：約 100-200 MB（臨時）
- 過濾處理：約 50-100 MB

## 安全性注意事項

1. **資料來源驗證**：只從官方網站下載
2. **HTTPS 連線**：使用安全連線
3. **檔案檢查**：下載後檢查檔案完整性
4. **授權遵守**：嚴格遵守 OGDL 授權條款

## 未來優化

1. **增量更新**：只下載新增資料
2. **資料庫儲存**：使用 PostgreSQL 替代 CSV
3. **分散式快取**：使用 Redis
4. **監控告警**：下載失敗時發送通知
5. **定時任務**：使用 cron job 定期更新

---

**版本：** 1.0.0
**更新日期：** 2025-11-02
**維護者：** VicBot Team
