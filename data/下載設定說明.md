# 自動下載政府開放資料設定說明

## 功能概述

房價查詢功能現已支援自動從政府開放資料平台下載最新的實價登錄資料。

### 主要特性

- ✅ **自動檢查更新**：Bot 啟動時自動檢查資料是否需要更新
- ✅ **7天快取機制**：資料下載後 7 天內使用快取，避免頻繁下載
- ✅ **多城市支援**：支援台中、台北、新北、高雄等主要城市
- ✅ **錯誤降級**：下載失敗時自動使用舊快取
- ✅ **Discord 日誌**：下載狀態自動記錄到 Discord 頻道

## 快速開始

### 1. 測試自動下載功能

```bash
python3 test_data_downloader.py
```

**預期輸出：**
```
✅ 房價資料快取有效（0天前更新，7天後過期）
✅ 資料已就緒 | path=data/taichung_prices.csv
```

### 2. 啟動 Bot（自動檢查資料）

```bash
python3 bot.py
```

**日誌範例：**
```
INFO:__main__:🔄 檢查房價資料更新...
INFO:src.services.data_downloader:✅ 使用快取資料 | city=台中市 | path=taichung_prices.csv
INFO:__main__:✅ 房價資料已就緒
```

## 進階設定

### 設定政府開放資料 URL

目前 `src/services/data_downloader.py` 中的 URL 為範例，需要替換為真實的政府資料連結。

#### 方法 1：使用政府資料開放平台 API

1. 前往 https://data.gov.tw/
2. 搜尋「不動產買賣實價登錄」
3. 找到對應城市的資料集
4. 複製 API 下載連結

**範例：**
```python
DATA_SOURCES = {
    "taichung": {
        "name": "台中市",
        "url": "https://data.gov.tw/api/v2/rest/dataset/export?dataset_id=123456",  # 替換為真實 ID
        "filename": "taichung_prices.csv",
        "description": "台中市不動產買賣實價登錄",
    },
}
```

#### 方法 2：使用內政部實價登錄直接下載連結

1. 前往 https://plvr.land.moi.gov.tw/
2. 選擇「批次下載」
3. 選擇城市和時間範圍
4. 取得下載連結

**範例：**
```python
DATA_SOURCES = {
    "taichung": {
        "name": "台中市",
        "url": "https://plvr.land.moi.gov.tw/DownloadOpenData?type=season&fileName=lvr_landcsv.zip",
        "filename": "taichung_prices.csv",
        "description": "台中市不動產買賣實價登錄",
    },
}
```

### 調整快取有效期

預設快取有效期為 7 天，可在 `data_downloader.py` 中修改：

```python
# 快取有效期（天數）
CACHE_VALIDITY_DAYS = 7  # 改為 14 天或其他天數
```

### 停用自動下載

如果想停用自動下載，只使用本地檔案：

**方法 1：在 `.env` 中設定**
```env
PRICE_QUERY_ENABLED=false
```

**方法 2：在查詢時停用**
```python
# 在 price_query.py 中
await load_csv_data(auto_download=False)
```

## 測試場景

### 場景 1：首次啟動（無本地檔案）

```bash
# 刪除本地檔案
rm data/taichung_prices.csv

# 啟動 Bot
python3 bot.py
```

**預期行為：**
1. 檢測到檔案不存在
2. 自動下載最新資料
3. 下載成功後記錄到 Discord

### 場景 2：快取有效（7天內）

```bash
# 啟動 Bot
python3 bot.py
```

**預期行為：**
1. 檢測到快取有效
2. 使用本地檔案，不重新下載
3. 記錄快取資訊到 Discord

### 場景 3：快取過期（超過 7 天）

```bash
# 手動修改檔案修改時間（模擬過期）
touch -d "8 days ago" data/taichung_prices.csv

# 啟動 Bot
python3 bot.py
```

**預期行為：**
1. 檢測到快取過期
2. 自動下載最新資料
3. 下載成功後記錄到 Discord

### 場景 4：下載失敗（網路問題）

```bash
# 修改 URL 為無效連結
# 然後啟動 Bot
python3 bot.py
```

**預期行為：**
1. 嘗試下載失敗
2. 自動使用舊快取（如果存在）
3. 記錄錯誤到 Discord #異常警告 頻道

## 手動操作

### 手動下載台中市資料

```bash
python3 -c "
import asyncio
from src.services import data_downloader
asyncio.run(data_downloader.download_taichung_data(force=True))
"
```

### 手動下載所有城市資料

```bash
python3 -c "
import asyncio
from src.services import data_downloader
asyncio.run(data_downloader.download_all_cities(force=True))
"
```

### 檢查快取資訊

```bash
python3 -c "
from src.services import data_downloader
info = data_downloader.get_taichung_cache_info()
print(f'城市：{info[\"city\"]}')
print(f'檔案年齡：{info[\"age_days\"]} 天')
print(f'是否有效：{info[\"is_valid\"]}')
"
```

### 清空快取（強制重新下載）

```bash
rm data/taichung_prices.csv
python3 bot.py
```

## 監控與日誌

### Discord 日誌頻道

自動下載狀態會記錄到以下 Discord 頻道：

- **#系統日誌**：正常的下載成功、快取命中訊息
- **#異常警告**：下載失敗、快取過期警告

**日誌範例：**
```
ℹ️ [2025-11-02 10:30:15] 房價資料快取有效（2天前更新，5天後過期）
⚠️ [2025-11-02 10:30:15] 房價資料快取已過期（8天），正在下載最新資料...
✅ [2025-11-02 10:30:30] 房價資料已就緒
🚨 [2025-11-02 10:30:45] 房價資料下載失敗：網路連線錯誤
```

### 終端機日誌

啟動 Bot 時，終端機會顯示詳細日誌：

```
INFO:__main__:房價查詢功能已啟用 | cache_ttl=24小時
INFO:__main__:🔄 檢查房價資料更新...
INFO:src.services.data_downloader:快取仍有效 | path=taichung_prices.csv | age=2天 | valid_until=7天
INFO:src.services.data_downloader:✅ 使用快取資料 | city=台中市 | path=taichung_prices.csv
INFO:__main__:✅ 房價資料已就緒 | path=/home/.../data/taichung_prices.csv
```

## 檔案結構

```
homescout-taichung001/
├── data/
│   ├── taichung_prices.csv      # 台中市資料（自動下載或手動放置）
│   ├── taipei_prices.csv        # 台北市資料（可選）
│   ├── new_taipei_prices.csv    # 新北市資料（可選）
│   └── kaohsiung_prices.csv     # 高雄市資料（可選）
├── src/
│   └── services/
│       ├── data_downloader.py   # 下載服務模組
│       └── price_query.py       # 房價查詢服務（整合下載）
├── test_data_downloader.py      # 測試腳本
└── bot.py                        # Bot 主程式（啟動時自動檢查）
```

## 常見問題

### Q1: 下載失敗怎麼辦？

**原因：** URL 無效、網路問題、政府網站維護

**解決方法：**
1. 檢查 `data_downloader.py` 中的 URL 是否正確
2. 檢查網路連線
3. 使用舊快取（如果存在）
4. 手動下載 CSV 並放置於 `data/` 目錄

### Q2: 如何知道資料是否最新？

**方法 1：查看檔案修改時間**
```bash
ls -lh data/taichung_prices.csv
```

**方法 2：執行測試腳本**
```bash
python3 test_data_downloader.py
```

**方法 3：查看 Discord #系統日誌 頻道**

### Q3: 可以手動上傳 CSV 檔案嗎？

**可以！** 自動下載功能是可選的，你可以：

1. 從政府平台手動下載 CSV
2. 將檔案放置於 `data/taichung_prices.csv`
3. 啟動 Bot，系統會自動使用該檔案

### Q4: 如何更換資料來源城市？

修改 `data_downloader.py` 中的 `DATA_SOURCES` 配置，或在 `price_query.py` 中指定不同的 CSV 檔案：

```python
# 使用台北市資料
await load_csv_data("data/taipei_prices.csv")
```

### Q5: 下載的檔案太大，影響效能？

**解決方法：**
1. 增加快取有效期（減少下載頻率）
2. 使用資料庫存儲（替代 CSV）
3. 篩選只下載特定時間範圍的資料
4. 使用 `pandas` 優化大型 CSV 讀取

## 效能優化建議

### 1. 增加快取有效期

```python
# 改為 30 天
CACHE_VALIDITY_DAYS = 30
```

### 2. 使用 Redis 快取（進階）

```python
# 將資料快取到 Redis，避免每次讀取 CSV
import redis
r = redis.Redis()
r.set("taichung_prices", csv_data, ex=86400*7)
```

### 3. 定期自動更新（Cron Job）

```bash
# 每週日凌晨 3 點自動更新
0 3 * * 0 cd /path/to/project && python3 -c "import asyncio; from src.services import data_downloader; asyncio.run(data_downloader.download_all_cities(force=True))"
```

## 安全性注意事項

1. **URL 驗證**：確保下載來源為政府官方網站
2. **檔案大小限制**：設定最大下載檔案大小（防止 DoS）
3. **SSL 驗證**：使用 HTTPS 連結
4. **權限控制**：限制誰可以觸發強制下載

## 下一步

1. ✅ 測試自動下載功能
2. ⚠️ 更新 `DATA_SOURCES` 中的真實政府資料 URL
3. ✅ 設定 Discord 日誌頻道 ID
4. ✅ 監控首次下載和資料更新
5. ⚠️ 考慮使用資料庫替代 CSV（效能優化）

## 聯絡資訊

如有問題，請聯繫：
- GitHub Issues: [專案連結]
- Discord: [管理員聯繫方式]
