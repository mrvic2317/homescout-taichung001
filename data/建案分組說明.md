# 建案分組功能說明

## 功能概述

房價查詢結果現已支援智能建案分組，自動將同路段、門牌相近的交易記錄合併為推測建案。

### 核心特性

- ✅ **地址解析**：自動提取路段名稱和門牌號碼
- ✅ **智能分組**：同路段內，門牌相差 ≤ 100 號視為同社區
- ✅ **排序展示**：按路段名稱 A-Z、門牌號碼由小到大排序
- ✅ **門牌列表**：顯示每個建案的所有成交門牌
- ✅ **統計資訊**：每個建案的成交筆數、平均單價、平均總價

## 分組邏輯

### 方案 1：路段分組

首先按路段名稱分組（例如：文心路四段、崇德路二段）。

**範例：**
```
文心路四段 → 一組
崇德路二段 → 另一組
市政路 → 又一組
```

### 方案 2：門牌相近度

同路段內，按門牌號碼相近度細分：

- **門牌相差 ≤ 100 號** → 合併為同一建案
- **門牌相差 > 100 號** → 分開展示

**範例：**
```
文心路四段 100號
文心路四段 105號  } → 合併為「文心路四段 100-110號」
文心路四段 110號

文心路四段 300號  } → 分開展示為「文心路四段 300號」
```

### 預設閾值

- **門牌相近閾值：** 100 號
- **可調整範圍：** 50-500 號

## 查詢結果範例

### Discord Embed 格式

```
📊 北屯區房價統計
過去 5 年成交記錄（11201 ~ 11305）

【📈 整體統計】
總交易筆數：14 筆
建案分組數：11 個
平均總價：830.71 萬元
平均單價：7.22 萬/坪

【🏢 文心路四段 100-110號 (推測同社區)】
成交筆數：3 筆
平均總價：900.00 萬元
平均單價：7.30 萬/坪
成交門牌：#100, #105, #110

【🏢 崇德路二段 200號】
成交筆數：1 筆
平均總價：1200.00 萬元
平均單價：7.53 萬/坪
成交門牌：#200

【🏢 北屯路 50號】
成交筆數：1 筆
平均總價：680.00 萬元
平均單價：7.12 萬/坪
成交門牌：#50

【💰 價格區間】
最高總價：1200.00 萬元
最低總價：680.00 萬元
最高單價：7.53 萬/坪
最低單價：7.07 萬/坪
```

### 命令列輸出

```bash
python3 test_project_grouping.py
```

```
文心路四段 100-110號
  成交筆數：3 筆
  平均總價：900.00 萬元
  平均單價：7.30 萬/坪
  成交門牌：#100, #105, #110
```

## 使用方式

### Discord 指令

```
!房價查詢 北屯區
!房價查詢 西屯區
!房價查詢 南屯區
```

結果會自動包含建案分組資訊。

### Python API

```python
import asyncio
from src.services import price_query

async def main():
    # 查詢房價
    stats = await price_query.query_price("北屯區")

    # 查看分組結果
    print(f"建案分組數：{len(stats.project_groups)}")

    for group in stats.project_groups:
        print(f"{group.road_name} {group.address_range}")
        print(f"  成交筆數：{group.transaction_count} 筆")
        print(f"  平均單價：{group.avg_unit_price:.2f} 萬/坪")
        print(f"  成交門牌：{', '.join(group.addresses)}")

asyncio.run(main())
```

## 進階設定

### 調整門牌相近閾值

在 `src/services/price_query.py` 中修改：

```python
# 預設閾值：100 號
project_groups = group_by_project(transactions, proximity_threshold=100)

# 調整為 50 號（分組更細）
project_groups = group_by_project(transactions, proximity_threshold=50)

# 調整為 200 號（分組更粗）
project_groups = group_by_project(transactions, proximity_threshold=200)
```

### 不同閾值效果

| 閾值 | 效果 | 適用場景 |
|-----|------|---------|
| 50 號 | 分組細緻 | 大型社區密集區 |
| 100 號 | 適中（預設） | 一般市區 |
| 200 號 | 分組較粗 | 郊區或低密度區域 |
| 500 號 | 分組很粗 | 特殊需求 |

**範例比較：**

```bash
# 閾值 50 號
文心路四段 100-105號 (2筆)
文心路四段 110號 (1筆)

# 閾值 100 號（預設）
文心路四段 100-110號 (3筆)

# 閾值 200 號
文心路四段 100-200號 (5筆)
```

## 測試與驗證

### 執行測試腳本

```bash
python3 test_project_grouping.py
```

### 測試涵蓋範圍

1. ✅ 地址解析測試
2. ✅ 建案分組邏輯測試
3. ✅ 完整查詢流程測試
4. ✅ 門牌相近度閾值測試
5. ✅ 邊界情況測試

### 預期輸出

```
✅ 成功讀取北屯區交易記錄 | 總筆數：14
✅ 分組完成 | 分組數：11

文心路四段 100-110號
  成交筆數：3 筆
  平均總價：900.00 萬元
  平均單價：7.30 萬/坪
  成交門牌：#100, #105, #110
```

## 實際應用場景

### 場景 1：查詢某路段建案

```
!房價查詢 北屯區文心路
```

結果會顯示：
- 文心路一段、二段、三段、四段的所有建案
- 每個路段內按門牌分組
- 便於比較同路段不同社區的價格

### 場景 2：鎖定特定社區

```
文心路四段 100-110號 (推測同社區)
成交筆數：3 筆
平均單價：7.30 萬/坪
成交門牌：#100, #105, #110
```

房仲可以：
1. 識別潛在建案位置
2. 聯繫該社區住戶
3. 了解該社區成交行情

### 場景 3：區域價格比較

```
北屯區房價統計
- 文心路四段 100-110號：7.30 萬/坪
- 崇德路二段 200號：7.53 萬/坪
- 北屯路 50號：7.12 萬/坪
```

快速比較不同路段、不同建案的價格差異。

## 限制與注意事項

### 1. 資料隱私

政府實價登錄資料為保護隱私，可能會：
- 模糊化門牌號碼（僅顯示路段，不顯示號碼）
- 刪除部分敏感資訊

**影響：**
- 如果 CSV 資料無門牌號碼，分組會顯示「未知門牌」
- 分組仍會按路段進行

### 2. 地址解析準確度

支援的地址格式：
- ✅ 臺中市北屯區文心路四段100號
- ✅ 台中市西屯區市政路500號
- ✅ 北屯區昌平路1段50號
- ✅ 文心路四段200號
- ⚠️ 文心路四段（無門牌）→ 顯示「未知門牌」
- ❌ 複雜地址（例如：巷弄樓之）→ 可能解析失敗

### 3. 分組準確性

「推測同社區」基於：
- 同路段
- 門牌相近（≤ 100 號）

**並非保證：**
- 實際可能是不同建案
- 建議搭配其他資訊（屋齡、建物型態）確認

### 4. 效能考量

- 大量交易記錄（> 1000 筆）可能影響效能
- Discord Embed 最多顯示 25 個欄位，限制顯示 10 個分組
- 如有更多分組，會提示「還有 N 個建案分組未顯示」

## 疑難排解

### Q1: 為何所有分組都顯示「未知門牌」？

**原因：** CSV 資料中的地址欄位沒有門牌號碼

**解決方法：**
1. 檢查 CSV 檔案的「土地位置建物門牌」欄位
2. 確認是否包含門牌號碼（例如：100號）
3. 如果使用政府原始資料，這是正常的（隱私保護）

### Q2: 分組太多或太少怎麼辦？

**分組太多（過細）：**
- 增加門牌相近閾值（改為 200 或 500）

**分組太少（過粗）：**
- 減少門牌相近閾值（改為 50）

**調整位置：**
```python
# src/services/price_query.py, line 850
project_groups = group_by_project(transactions, proximity_threshold=100)
```

### Q3: Discord 顯示「還有 N 個分組未顯示」

**原因：** 建案分組超過 10 個，Discord Embed 限制

**解決方法：**
1. 使用更具體的查詢條件（例如：指定路名）
2. 增加門牌相近閾值（減少分組數量）
3. 未來可考慮分頁顯示

### Q4: 如何查看所有分組？

使用 Python API：

```python
stats = await price_query.query_price("北屯區")

# 顯示所有分組（不限制 10 個）
for group in stats.project_groups:
    print(f"{group.road_name} {group.address_range}: {group.transaction_count} 筆")
```

### Q5: 地址解析失敗怎麼辦？

**現象：** 路段名稱為 None 或門牌號碼錯誤

**可能原因：**
- 地址格式不標準
- 包含特殊字符（巷、弄、樓、之）
- 地址過於複雜

**解決方法：**
1. 檢查 CSV 資料中的地址格式
2. 在 `parse_address()` 函數中新增正則表達式規則
3. 提供 Issue 回報特殊案例

## 未來優化方向

1. **智能建案識別**
   - 結合屋齡、建物型態、樓層等資訊
   - 機器學習識別相同建案

2. **建案名稱匹配**
   - 整合建案名稱資料庫
   - 顯示實際建案名稱（例如：「文心麗舍」）

3. **分頁展示**
   - 超過 10 個分組時使用分頁按鈕
   - Discord Interaction 互動式瀏覽

4. **圖表視覺化**
   - 生成價格分布圖
   - 建案位置地圖標記

5. **匯出功能**
   - 匯出為 Excel 或 PDF
   - 包含完整建案分組資訊

## 貢獻與回饋

如有問題或建議，請：
- 提交 GitHub Issue
- 聯繫開發團隊
- 參與討論與改進

---

**版本：** 1.0.0
**更新日期：** 2025-11-02
**作者：** VicBot Team
